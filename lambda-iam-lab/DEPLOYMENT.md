# AWS Lambda and S3 with IAM Roles - Deployment Guide

## What This Stack Creates

This CDK stack creates the following AWS resources:

1. **S3 Bucket**
   - Server-side encryption enabled
   - Auto-delete objects on stack destroy (clean removal)
   - Unique name generated by CDK

2. **Lambda Function**
   - Python 3.11 runtime
   - Lists objects in the S3 bucket
   - Environment variable with bucket name
   - 30-second timeout, 128MB memory

3. **IAM Roles**
   - **Lambda Execution Role**: 
     - CloudWatch Logs permissions (AWSLambdaBasicExecutionRole)
     - Read/Write access to the S3 bucket
   - **S3 Access Role**: 
     - Standalone role with S3 read/write access
     - Can be assumed by your AWS account

## Prerequisites

1. AWS Account with proper credentials configured
2. AWS CLI installed and configured (`aws configure`)
3. Python 3.x installed
4. Node.js installed
5. AWS CDK installed globally (`npm install -g aws-cdk`)

## Initial Setup

### 1. Bootstrap your AWS environment (first time only)

```bash
cdk bootstrap aws://ACCOUNT-NUMBER/REGION
```

Example:
```bash
cdk bootstrap aws://123456789012/us-east-1
```

Or use your default account/region:
```bash
cdk bootstrap
```

## Deployment Steps

### 1. Activate the virtual environment

```bash
source .venv/bin/activate
```

### 2. Verify the stack configuration

```bash
cdk synth
```

This will show you the CloudFormation template that will be created.

### 3. Review the changes (optional)

```bash
cdk diff
```

### 4. Deploy the stack

```bash
cdk deploy
```

You'll see a confirmation prompt. Review the IAM statement changes and type 'y' to proceed.

### 5. Note the outputs

After deployment, you'll see outputs like:
```
Outputs:
LambdaIamLabStack.BucketName = lambdaiamlab-lambdadatabucket...
LambdaIamLabStack.LambdaFunctionName = LambdaIamLabStack-S3ProcessorFunction...
LambdaIamLabStack.LambdaRoleArn = arn:aws:iam::123456789012:role/...
LambdaIamLabStack.S3RoleArn = arn:aws:iam::123456789012:role/...
```

## Testing Your Deployment

### Test the Lambda function

```bash
aws lambda invoke \
  --function-name <LAMBDA_FUNCTION_NAME> \
  --payload '{}' \
  output.json

cat output.json
```

### Upload a test file to S3

```bash
echo "Hello World" > test.txt
aws s3 cp test.txt s3://<BUCKET_NAME>/
```

### Test Lambda again to see the file

```bash
aws lambda invoke \
  --function-name <LAMBDA_FUNCTION_NAME> \
  --payload '{}' \
  output.json

cat output.json
```

## Clean Destroy (Remove Everything)

### Option 1: Using CDK (Recommended)

```bash
cdk destroy
```

This will:
- Automatically delete all objects in the S3 bucket
- Remove the bucket
- Delete the Lambda function
- Remove all IAM roles and policies
- Clean up all CloudFormation resources

Type 'y' when prompted to confirm deletion.

### Option 2: Manual verification after destroy

Check that resources are removed:

```bash
# List remaining Lambda functions
aws lambda list-functions --query "Functions[?contains(FunctionName, 'S3Processor')]"

# List remaining S3 buckets
aws s3 ls | grep lambdaiamlab

# List remaining IAM roles
aws iam list-roles --query "Roles[?contains(RoleName, 'LambdaIamLabStack')]"
```

## Important Features for Clean Destroy

1. **S3 Bucket Auto-Delete**: The bucket is configured with:
   ```python
   removal_policy=RemovalPolicy.DESTROY
   auto_delete_objects=True
   ```
   This ensures all objects are deleted before the bucket is removed.

2. **No Retention Conflicts**: Lambda log groups are set to retain, but can be manually deleted if needed.

3. **IAM Roles**: All IAM roles and policies are automatically removed with the stack.

## Cost Considerations

- **S3**: Pay per GB stored and per request
- **Lambda**: Free tier: 1M requests/month, 400,000 GB-seconds compute
- **CloudWatch Logs**: Free tier: 5GB ingestion, 5GB storage
- **IAM Roles**: Free

Most usage will fall within AWS Free Tier limits.

## Troubleshooting

### Issue: CDK Bootstrap Error
**Solution**: Run `cdk bootstrap` first

### Issue: Bucket not deleting
**Solution**: The stack handles this automatically with `auto_delete_objects=True`

### Issue: IAM permissions error
**Solution**: Ensure your AWS credentials have sufficient permissions to create IAM roles

### Issue: Stack already exists
**Solution**: Use `cdk destroy` first, then redeploy

## Customization

### Change Lambda Runtime
Edit `lambda_iam_lab_stack.py`:
```python
runtime=lambda_.Runtime.PYTHON_3_12,  # or PYTHON_3_10, etc.
```

### Add More Permissions
```python
# Add another managed policy
lambda_role.add_managed_policy(
    iam.ManagedPolicy.from_aws_managed_policy_name("AmazonDynamoDBReadOnlyAccess")
)
```

### Change Region
Edit `app.py` and uncomment:
```python
env=cdk.Environment(account='123456789012', region='us-west-2')
```

## Useful CDK Commands

- `cdk ls` - List all stacks
- `cdk synth` - Synthesize CloudFormation template
- `cdk deploy` - Deploy the stack
- `cdk diff` - Compare deployed stack with current state
- `cdk destroy` - Remove all resources
- `cdk doctor` - Check CDK environment
- `cdk docs` - Open CDK documentation

## Security Best Practices

1. ✅ Principle of Least Privilege - Roles have only necessary permissions
2. ✅ Encryption at Rest - S3 bucket uses AES256 encryption
3. ✅ No Hardcoded Credentials - Uses IAM roles for authentication
4. ✅ CloudWatch Logging - Lambda logs all invocations
5. ✅ Resource Cleanup - Auto-delete prevents orphaned resources

